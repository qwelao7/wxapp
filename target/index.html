<!DOCTYPE html>
<html class="pixel-ratio-2 retina ios ios-11 ios-11-0 ios-gt-10 ios-gt-9 ios-gt-8 ios-gt-7 ios-gt-6">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <title>创建生活秀</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
  <link rel="stylesheet" href="https://g.alicdn.com/msui/sm/0.6.2/css/sm.min.css"/>
  <script src="https://g.alicdn.com/sj/lib/zepto/zepto.min.js" charset="utf-8"></script>
  <!--<link href="/style.css" rel="stylesheet"/>-->
  <link href="style.css" rel="stylesheet"/>
  <style type="text/css">
    content {
      background-color: #fffcf5;
    }

    input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {
      /* WebKit browsers */
      color: #aaa;
    }

    input:-moz-placeholder, textarea:-moz-placeholder {
      /* Mozilla Firefox 4 to 18 */
      color: #aaa;
    }

    input::-moz-placeholder, textarea::-moz-placeholder {
      /* Mozilla Firefox 19+ */
      color: #aaa;
    }

    input:-ms-input-placeholder, textarea:-ms-input-placeholder {
      /* Internet Explorer 10+ */
      color: #aaa;
    }

    .item-content {
      padding: 0 !important;
    }

    .pickerClass {
      background-color: #fff;
    }

    .filePicker {
      /*background: none repeat scroll 0 0 #00B7EE;*/
      /*border-radius: 3px;*/
      /*box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);*/
      /*color: #FFFFFF;*/
      /*cursor: pointer;*/
      /*display: inline-block;*/
      /*font-size: 18px;*/
      /*height: 44px;*/
      /*line-height: 44px;*/
      /*width: 90%;*/
      /*min-width: 120px;*/
      /*margin: 0 auto 0px;*/
      /*overflow: hidden;*/
      /*transition: background 0.2s;*/
      /*-moz-transition: background 0.2s;*/
      /*-webkit-transition: background 0.2s;*/
      /*-o-transition: background 0.2s;*/
      display: inline-block;
      width: calc(32.2vw - 10px);
      height: calc(32.2vw - 10px);
      padding-bottom: 10px;
      padding-right: 10px;
      background-image: url("image_add.png");
      background-size: 100% 100%;
    }

    #preview {
      margin-top: 30px;
    }

    #preview img {
      width: calc(32.2vw - 10px);
      height: calc(32.2vw - 10px);
      padding-bottom: 10px;
      padding-right: 10px;

    }
  </style>
</head>
<body>
<div class="page-group">
  <div class="page page-current" id="register">
    <div class="content native-scroll" style="padding: 0 15px;background-color: #fffcf5;">
      <div class="content-block sms-content-block">

        <div class="list-block" style="margin: 0;">
          <ul style="background-color: #fffcf5;">
            <li class="item-contenZt item-link">
              <div class="item-inner">
                <div class="item-title" style="padding: 0;width: 100%">
                  <input type="text" id="project" placeholder="请选择项目名称" style="font-size: 13px">
                </div>
              </div>
            </li>
          </ul>
        </div>
        <textarea name="detail" id="detail" placeholder="请在此处填写留言详情"
                  style="width: 100%;height: 180px;background-color: #f5f5f5;border: none;font-size: 13px;padding: 8px 10px"></textarea>
        <img id="resultImage" style="display: none!important;"/>
        <div id="preview">
          <div id="dd" class="filePicker"></div>
        </div>

        <a class="button btn-lg btn-confirm index-btn-next alert-text" id="btn"
           style="background-color:#9e7f60!important;">
          提 交
        </a>
      </div>


    </div>
  </div>
</div>

<script src="https://g.alicdn.com/msui/sm/0.6.2/js/sm.min.js" charset="utf-8"></script>
<!--<script type="text/javascript" src="/unit.js"></script>-->
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
<script type="text/javascript" src="unit.js"></script>
<script src="./aliyun-oss-sdk-6.0.1.min.js"></script>
<script src="h5upload.js"></script>
<script type="text/javascript">
  $(function () {
    'use strict';
    $(document).on("pageInit", "#register", function (e, id, page) {
      var data = {};

      function getUrlParam (name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
      }

      $.fileUpload({filebutton: "#dd", previewZoom: "#preview"});
      $("#project").picker({
        toolbarTemplate: '<header class="bar bar-nav" style="background-color: #fff!important;">\
                            <button class="button button-link pull-right close-picker" style="color: #0dab60">确定</button>\
                            <h1 class="title" style="color: #0dab60!important;">请选择项目</h1>\
                        </header>',
        cols: [
          {
            textAlign: 'center',
            // displayValues: [1, 2, 3, 4, 5],
            //如果你希望显示文案和实际值不同，可以在这里加一个displayValues: [.....]
            values: ['濮塘·桃里', '协鑫春风江南', '南京桃花源', '宝华桃李春风', '园博村·桃李春风']
          }
        ],
        cssClass: 'pickerClass'
      });

      $(document).on('click', '#btn', function () {
        console.log(imgLists)
        console.log(imgCount)
        let pickerInfo = [
          {
            communityId: '9832d325-51d8-11e8-9faf-48d539affdb4',
            name: '濮塘·桃里'
          },
          {
            communityId: 'ee8f78d0-51d7-11e8-9faf-48d539affdb4',
            name: '协鑫春风江南'
          },
          {
            communityId: '046ba2c8-328c-11e8-9faf-48d539affdb4',
            name: '南京桃花源'
          },
          {
            communityId: '585e764f-328c-11e8-9faf-48d539affdb4',
            name: '宝华桃李春风'
          },
          {
            communityId: 'a4352cc4-51c9-11e8-9faf-48d539affdb4',
            name: '园博村·桃李春风'
          }
        ];
        let communityId = ''
        pickerInfo.forEach(item => {
          if ($('#project').val() === item.name) {
            communityId = item.communityId
          }
        })
        data.token = getUrlParam('token')
        data.topicContent = $('#detail').val()
        data.communityId = communityId
        data.imgUrls = imgLists
        console.log(data)
        if (!data.topicContent) {
          $.toast("请输入内容");
        } else if (!data.communityId) {
          $.toast("请选择发布小区");
        } else if (imgLists.length < imgCount) {
          $.toast("图片上传中，请稍后提交");
        } else {
          $.ajax({
            url: 'https://signin.huilaila.net/club/posts?topicType=6&topicContent=' + data.topicContent + '&communityId=' + data.communityId + '&imageUrls=' + JSON.stringify(data.imgUrls),
            type: 'POST',
            headers: {token: data.token},
            success: function (res) {
              if (res.status === 100) {
                $.toast('发布成功')
                setTimeout(function () {
                  wx.miniProgram.navigateBack({
                    delta: 1
                  })
                }, 1000)
              } else {
                $.toast("网络错误，请重新提交");
              }
            },
            error: function (e) {
              console.log(e)
              $.toast("网络错误，请重新提交");
            }
          })
        }

      });
    });
    $.init();
  });
</script>
</body>
</html>
